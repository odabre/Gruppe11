<html>
    <head>
        <title>Temperatur</title>
        <link rel="stylesheet" href="{{ url_for('static', filename='main_style.css') }}">
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    </head>
    <body>
        <div class="main">
            <div class = "sidebar">
                <a href="{{url_for('run')}}">
                    <img src="{{url_for('static', filename='487BDFE8-69CE-4ACF-858A-F14382F42528_4_5005_c.jpeg') }}" alt="Logo" class="logo">
                </a>
                <ul>
                    <li><a href="/ph">PH</a></li>
                    <li><a href="/temperatur">Temperatur</a></li>
                    <li><a href="/sensor">Total dissolved solids</a></li>
                    <li><a href="/turbiditet">Turbiditet</a></li>
                </ul>

                    <div class = "link-container">
                        <a href="https://www.facebook.com/MausundFeltstasjon/" target="_blank">
                            <img src="{{url_for('static', filename='facebook.jpg') }}" alt="Facebook" class="facebook">
                        </a>
                        <a href="https://www.instagram.com/mausundfeltstasjon/" target="_blank">
                            <img src="{{url_for('static', filename='instagram.jpg') }}" alt="Instagram" class="instagram">
                        </a>
                        <a href="https://twitter.com/MausundF" target="_blank">
                            <img src="{{url_for('static', filename='twitter.jpg') }}" alt="X" class="twitter">
                        </a>
                    </div>
                </div>
            <div class = "content">
                <h1>Temperatur</h1>
                    <table border="1">
                        <tbody id="data-table">
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                    
                    <canvas id = "myChart" width="200" height = "100"></canvas>
                    <a href="/download_temperatur_csv" style="color:rgb(2, 77, 102);">Klikk her for å laste ned temperaturdata</a>

                    <p>Her skal vi skrive informasjon om temperaturmålingene våre. Hvis det trengs</p>

            </div>
        </div>
        <script>
            const ctx = document.getElementById("myChart").getContext("2d");
            const myChart = new Chart(ctx, {
                type:"line",
                data:{
                    labels:[],
                    datasets:[{
                        label:"Temperatur",
                        data:[],
                        borderColor: "rgba(75,192,192, 1)",
                        borderWidth:1,
                        fill: false
                    }]
                },
                options:{
                    scales:{
                         y:{
                            beginAtZero:true,
                            title:{
                                display: true,
                                text: "Grader i celsius"
                            }
                        },
                        x:{
                            title:{
                                display: true,
                                text: "tid"
                            }
                        }
                    }
                }
            });
            
                function update_chart() {
                    fetch("/update_temperatur")
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok ' + response.statusText);
                        }
                        return response.json();
                    })
                    .then(data_temperatur_graf => {
                        // Log received data for debugging
                        console.log('Data mottatt:', data_temperatur_graf);

                        const maxDataPoints = 20; // Maks antall punkter på grafen

                        // Legg til ny tidsstempel og temperaturverdi
                        const newTimestamp = data_temperatur_graf.timestamp[data_temperatur_graf.timestamp.length - 1]; // Antatt å være et enkelt tidsstempel
                        const newTemperatur = data_temperatur_graf.temperatur[data_temperatur_graf.temperatur.length - 1]; // Antatt å være en enkel temperaturverdi

                        // Sjekk om vi allerede har nådd maks antall punkter
                        if (myChart.data.labels.length >= maxDataPoints) {
                            myChart.data.labels.shift(); // Fjern eldste x-verdi
                            myChart.data.datasets[0].data.shift(); // Fjern eldste y-verdi
                        }

                        // Legg til den nye verdien til slutten av listene
                        myChart.data.labels.push(newTimestamp); // Legg til nyeste x-verdi
                        myChart.data.datasets[0].data.push(newTemperatur); // Legg til nyeste y-verdi

                        myChart.update(); // Oppdater grafen
                    })
                    fetch('/download_temperatur_csv')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok ' + response.statusText);
                        }
                        return response.json();
                    })
                .catch(error => console.error("Feil ved henting av data:", error));
                }
                // Run the function on page load and update every 5 seconds
                setInterval(update_chart, 2000);
                
        </script>
    </body>
</html>